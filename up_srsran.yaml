---
- name: Up srsRAN server
  hosts: gnb
  become: yes
  vars:
    # Defina o usuário explicitamente se o ansible_user falhar
    username: "lance"
    user_home: "/home/{{ username }}"

  tasks:
    - name: Registrar inicio
      ansible.builtin.shell: |
        echo "$(date '+%Y-%m-%d %H:%M:%S') - Iniciado" >> {{ user_home }}/registros.txt
  
    - name: Clonar repositório customizado do srsRAN
      ansible.builtin.git:
        repo: "https://github.com/leafaraujo/srsRAN.git"
        dest: "{{ user_home }}/srsRAN"
        version: "main" 
        update: yes


    - name: Criar diretórios {{ ansible_env.HOME }}/srsRAN/build
      ansible.builtin.shell: mkdir {{ ansible_env.HOME }}/srsRAN/build
      args:
        executable: /bin/bash
      when: not srsRAN_instalado.stat.exists

    - name: Instalar dependências necessárias à compilação do srsRAN
      become: true
      apt:
        name:
        - cmake
        - make
        - gcc
        - g++
        - pkg-config
        - libfftw3-dev
        - libmbedtls-dev
        - libsctp-dev
        - libyaml-cpp-dev
        state: present
        update_cache: yes
    
    - name: Check if gnb binary exists
      ansible.builtin.stat:
        path: "{{ ansible_env.HOME }}/srsRAN/build/apps/gnb/gnb"
      register: gnb_binary_stat

    - name: Cmake srsRAN
      command: cmake ../
      args:
        chdir: "{{ ansible_env.HOME }}/srsRAN/build"
      when: not gnb_binary_stat.stat.exists

    - name: Build srsRAN
      become: true
      shell: |
        make -j"$(nproc)"
        make install
      args:
        chdir: "{{ ansible_env.HOME }}/srsRAN/build"
      when: not gnb_binary_stat.stat.exists

    - name: Permitir execução do binário gnb sem senha (via sudoers.d)
      become: true
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/gnb
        line: "{{ ansible_user }} ALL=(ALL) NOPASSWD: {{ ansible_env.HOME }}/srsRAN/build/apps/gnb/gnb"
        create: yes
        mode: '0440'
        validate: '/usr/sbin/visudo -cf %s'
      when: not gnb_binary_stat.stat.exists
    
    - name: Tornar gnb_up_b210.sh executável
      file:
        path: "{{ ansible_env.HOME }}/srsRAN/utils/gnb_up_b210.sh"
        mode: '0755'
        owner: "{{ ansible_user | default(omit) }}"
        group: "{{ ansible_user | default(omit) }}"
        state: file

    - name: Configurar Sudoers
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/gnb
        # Usamos o caminho absoluto para evitar erro de "~"
        line: "{{ username }} ALL=(ALL) NOPASSWD: {{ user_home }}/srsRAN/build/apps/gnb/gnb"
        create: yes
        mode: '0440'
        validate: '/usr/sbin/visudo -cf %s'

    - name: Ajustar permissões do script
      ansible.builtin.file:
        path: "{{ user_home }}/srsRAN/utils/gnb_up_b210.sh"
        mode: '0755'
        owner: "{{ username }}"
        group: "{{ username }}"
        state: file

    - name: Deploy docker-compose
      community.docker.docker_compose_v2:
        project_src: "{{ user_home }}/srsRAN/docker"
        files:
          - "docker-compose.yml"
        services:
          - grafana
          - influxdb
          - metrics-server
        state: present

    - name: Execute tmux session
      # Usamos 'become: no' aqui para o tmux rodar no usuário 'lance' e não no root
      become: no
      ansible.builtin.shell: |
        tmux has-session -t srsRAN_session 2>/dev/null || \
        tmux new -d -s srsRAN_session "cd {{ user_home }}/srsRAN/utils/ && ./gnb_up_b210.sh"
      args:
        executable: /bin/bash

    - name: Registrar fim
      ansible.builtin.shell: |
        echo "$(date '+%Y-%m-%d %H:%M:%S') - Finalizado" >> {{ user_home }}/registros.txt